"use strict";function ExpBar(a){PIXI.DisplayObjectContainer.call(this),this.emptyBar=new PIXI.Sprite(common.emptyBar),this.addChild(this.emptyBar),this.expBar=new PIXI.Sprite(common.expBar),this.addChild(this.expBar),this.position.x=0,this.position.y=common.RENDER_HEIGHT-common.emptyBar.height,this.level=a.data.level,this.exp=a.data.exp,this.expToNextLevel=a.data.expToNextLevel,common.expBar.frame=new PIXI.Rectangle(0,0,0,common.expBar.height),this.update(a.data.level,a.data.exp,a.data.expToNextLevel)}function Game(){this.stage=new PIXI.Stage(0),this.stage.interactive=!0,this.renderer=PIXI.autoDetectRenderer(window.innerWidth,window.innerHeight),document.body.appendChild(this.renderer.view),this.container=new PIXI.DisplayObjectContainer,this.sizeContainer(),this.stage.addChild(this.container),this.isLaunched=!1,requestAnimationFrame(render),this.frameCount=0,this.diff=0,this.lastTime=Date.now()}function render(){game.draw(),requestAnimFrame(render)}function Laser(a){this.data=a,PIXI.Sprite.call(this,common.lasers[a.sprite]),this.calculatePosition()}function LifeBar(a){PIXI.DisplayObjectContainer.call(this),this.position.x=0,this.position.y=0,this.emptyBar=new PIXI.Sprite(common.emptyBar),this.addChild(this.emptyBar),this.lifeBar=new PIXI.Sprite(common.lifeBar),this.addChild(this.lifeBar),this.hp=a.data.hp,this.hpMax=a.data.hpMax,this.update(a.data.hp,a.data.hpMax)}function Monster(a){this.data=a;var b=PIXI.Texture.fromImage("res/monster"+a.sprite+".png");PIXI.Sprite.call(this,b),this.calculatePosition()}function Network(){this.socket=io.connect(),this.handleConnexion()}function Other(a){this.data=a;var b=PIXI.Texture.fromImage("res/player"+a.sprite+".png");PIXI.Sprite.call(this,b),this.nameText=new PIXI.Text(a.name.toUpperCase()+"("+a.level+")",{font:"9px pressstart",fill:"white",dropShadow:!0}),this.nameText.anchor.x=.3,this.nameText.anchor.y=1.5,this.currentLevel=a.level,this.addChild(this.nameText),this.calculatePosition()}function Player(a){var b=PIXI.Texture.fromImage("res/player"+a.sprite+".png");PIXI.Sprite.call(this,b),this.data=a,this.calculatePosition(),console.log("Position:"+this.data.x+","+this.data.y),console.log("Position:"+this.position.x+","+this.position.y),this.nameText=new PIXI.Text(a.name.toUpperCase()+"("+a.level+")",{font:"9px pressstart",fill:"white",dropShadow:!0}),this.nameText.anchor.x=.3,this.nameText.anchor.y=1.5,this.currentLevel=a.level,this.addChild(this.nameText)}function Tiles(a){PIXI.DisplayObjectContainer.call(this),this.tilesHeight=a.length,this.tilesWidth=a[0].length,this.tiles=a,this.generateTiles()}function World(a){PIXI.DisplayObjectContainer.call(this),this.tiles=new Tiles(a.tiles),this.addChild(this.tiles),this.player=new Player(a.player),this.addChild(this.player),this.lasers={},this.players={};for(var b=a.players,c=0;c<b.length;c++){var d=b[c];this.players[d.name]=new Other(d),this.addChild(this.players[d.name])}this.monsters={};for(var e=a.monsters,c=0;c<e.length;c++){var f=e[c];this.monsters[f.id]=new Monster(f),this.addChild(this.monsters[f.id])}this.lifebar=new LifeBar(this.player),this.addChild(this.lifebar),this.expbar=new ExpBar(this.player),this.addChild(this.expbar)}var common={RENDER_WIDTH:1280,RENDER_HEIGHT:720,FRAME_TIME:20,TILE_SIZE:32};common.directions={TOP:0,BOTTOM:1,LEFT:2,RIGHT:3,MAX:4},common.lasers={0:PIXI.Texture.fromImage("res/laser.png"),1:PIXI.Texture.fromImage("res/monsterLaser.png")},common.emptyBar=PIXI.Texture.fromImage("res/emptybar.png"),common.lifeBar=PIXI.Texture.fromImage("res/lifebar.png"),common.expBar=PIXI.Texture.fromImage("res/expbar.png"),common.assetsToLoad=["res/emptybar.png","res/laser.png","res/monsterLaser.png","res/"],common.monsterSprites={0:{texture:PIXI.Texture.fromImage("res/monster0.png")},1:{texture:PIXI.Texture.fromImage("res/monster1.png")}},common.tiles={0:{texture:PIXI.Texture.fromImage("res/empty.png"),passable:!0},1:{texture:PIXI.Texture.fromImage("res/wall.png"),passable:!1}},ExpBar.prototype=Object.create(PIXI.DisplayObjectContainer.prototype),ExpBar.prototype.update=function(a,b,c){(a!=this.level||b!=this.exp||c!=this.expToNextLevel)&&(a!=this.level&&sounds.LEVEL_UP.play(),common.expBar.frame=new PIXI.Rectangle(0,0,b/c*common.expBar.width,common.expBar.height),this.level=a,this.exp=b,this.expToNextLevel=c)};var game;Game.prototype.sizeContainer=function(){var a=window.innerWidth/common.RENDER_WIDTH,b=window.innerHeight/common.RENDER_HEIGHT,c=Math.min(a,b);this.renderer.resize(common.RENDER_WIDTH*c,common.RENDER_HEIGHT*c),this.container.scale.x=c,this.container.scale.y=c},Game.prototype.startGame=function(a){console.log("Let's start the game !"),sounds.MUSIC.play(),world=new World(a),this.container.addChild(world),this.isLaunched=!0},Game.prototype.endGame=function(){var a=new PIXI.BlurFilter;world.filters=[a],buzz.all().stop(),sounds.GAME_OVER.play();var b=new PIXI.Text("GAME OVER. RESET IN 10 SECONDS.",{font:"30px pressstart",fill:"white",dropShadow:!0});b.position.x=common.RENDER_WIDTH/2-b.width/2,b.position.y=common.RENDER_HEIGHT/2-b.height/2,this.container.addChild(b),this.isLaunched=!1,setTimeout(function(){location.reload()},1e4)},Game.prototype.winGame=function(){var a=new PIXI.BlurFilter;world.filters=[a],buzz.all().stop();var b=new PIXI.Text("YOU GOT TO LEVEL 42. YOU WON. SORRY, THERE'S NO HEAVEN.",{font:"23px pressstart",fill:"white",dropShadow:!0});b.position.x=common.RENDER_WIDTH/2-b.width/2,b.position.y=common.RENDER_HEIGHT/2-b.height/2,this.container.addChild(b),this.isLaunched=!1},Game.prototype.invalidUsername=function(){var a=new PIXI.Text("YOU SUPPLIED AN INVALID USERNAME !",{font:"30px pressstart",fill:"white",dropShadow:!0});a.position.x=common.RENDER_WIDTH/2-a.width/2,a.position.y=common.RENDER_HEIGHT/2-a.height/2,this.container.addChild(a)},Game.prototype.alreadyConnectedFromSomewhereElse=function(){var a=new PIXI.Text("YOU'RE ALREADY CONNECTED FROM ANOTHER TAB !",{font:"30px pressstart",fill:"white",dropShadow:!0});a.position.x=common.RENDER_WIDTH/2-a.width/2,a.position.y=common.RENDER_HEIGHT/2-a.height/2,this.container.addChild(a)},Game.prototype.draw=function(){this.renderer.render(this.stage),this.frame()},Game.prototype.frame=function(){for(this.diff+=Date.now()-this.lastTime,this.lastTime=Date.now();this.diff>common.FRAME_TIME;)this.diff-=common.FRAME_TIME,this.frameCount++,game.isLaunched&&world.frame(this.frameCount)},window.onresize=function(){game.sizeContainer()};var game=new Game;Laser.prototype=Object.create(PIXI.Sprite.prototype),Laser.prototype.frame=function(){switch(this.data.direction){case common.directions.LEFT:this.data.x--;break;case common.directions.RIGHT:this.data.x++;break;case common.directions.TOP:this.data.y--;break;case common.directions.BOTTOM:this.data.y++}world.isAvailable(this.data.x,this.data.y)||world.removeLaser(this),this.calculatePosition()},Laser.prototype.calculatePosition=function(){this.position.x=this.data.x*common.TILE_SIZE,this.position.y=this.data.y*common.TILE_SIZE},LifeBar.prototype=Object.create(PIXI.DisplayObjectContainer.prototype),LifeBar.prototype.update=function(a,b){(this.hp!=a||this.hpMax!=b)&&(common.lifeBar.frame=new PIXI.Rectangle(0,0,a/b*common.lifeBar.width,common.lifeBar.height),this.hp=a,this.hpMax=b)},Monster.prototype=Object.create(PIXI.Sprite.prototype),Monster.prototype.update=function(a){this.data=a,this.calculatePosition()},Monster.prototype.calculatePosition=function(){this.position.x=this.data.x*common.TILE_SIZE,this.position.y=this.data.y*common.TILE_SIZE},Network.prototype.handleConnexion=function(){this.playerName=localStorage.getItem("playerName"),void 0==this.playerName?this.playerName=this.generatePlayerName(function(a){this.playerName=a,localStorage.setItem("playerName",a),this.connect()}):this.connect()},Network.prototype.connect=function(){console.log("Logging in as "+this.playerName),this.socket.emit("login",this.playerName),this.socket.on("initialData",function(a){game.startGame(a)}),this.socket.on("data",function(a){game.isLaunched&&world.updateData(a)}),this.socket.on("playerData",function(a){game.isLaunched&&world.updatePlayerData(a)}),this.socket.on("removePlayer",function(a){game.isLaunched&&world.removePlayer(a)}),this.socket.on("monsterData",function(a){game.isLaunched&&world.updateMonster(a)}),this.socket.on("removeMonster",function(a){game.isLaunched&&world.removeMonster(a)}),this.socket.on("laserData",function(a){game.isLaunched&&world.addLaser(a)}),this.socket.on("wrongUsername",function(){localStorage.removeItem("playerName"),game.invalidUsername()}),this.socket.on("death",function(){game.endGame()}),this.socket.on("winGame",function(){game.isLaunched&&(game.winGame(),this.socket.disconnect())}),this.socket.on("alreadyConnected",function(){game.alreadyConnectedFromSomewhereElse(),this.socket.disconnect()}),this.socket.on("damageTaken",function(){world.player.damageTaken()})},Network.prototype.generatePlayerName=function(a){var b=this;this.socket.emit("generateName"),this.socket.on("name",function(c){a.call(b,c)})};var network;$(window).bind("load",function(){network=new Network}),Other.prototype=Object.create(PIXI.Sprite.prototype),Other.prototype.update=function(a){a.level!=this.currentLevel&&(this.nameText.setText(a.name.toUpperCase()+"("+a.level+")"),this.currentLevel=a.level),this.data=a,this.calculatePosition()},Other.prototype.calculatePosition=function(){this.position.x=this.data.x*common.TILE_SIZE,this.position.y=this.data.y*common.TILE_SIZE},Player.prototype=Object.create(PIXI.Sprite.prototype),Player.prototype.calculatePosition=function(){this.position.x=this.data.x*common.TILE_SIZE,this.position.y=this.data.y*common.TILE_SIZE},Player.prototype.update=function(a){a.level!=this.currentLevel&&(this.nameText.setText(a.name.toUpperCase()+"("+a.level+")"),this.currentLevel=a.level),this.data=a,this.calculatePosition()},Player.prototype.frame=function(){var a=KeyboardJS.activeKeys();-1!=a.indexOf("up")?this.move(0,-1):-1!=a.indexOf("down")?this.move(0,1):-1!=a.indexOf("left")?this.move(-1,0):-1!=a.indexOf("right")&&this.move(1,0),(-1!=a.indexOf("enter")||-1!=a.indexOf("space"))&&this.shoot()},Player.prototype.shoot=function(){sounds.SHOOT.play(),network.socket.emit("shoot")},Player.prototype.move=function(a,b){world.isAvailable(this.data.x+a,this.data.y+b)&&(this.data.x+=a,this.data.y+=b,this.calculatePosition()),network.socket.emit("move",this.data.x,this.data.y)},Player.prototype.damageTaken=function(){sounds.HIT.play()};var sounds={};sounds.MUSIC=new buzz.sound("sounds/first",{formats:["mp3"],loop:!0}),sounds.MUSIC.setVolume(50),sounds.GAME_OVER=new buzz.sound("sounds/gameOver",{formats:["mp3"]}),sounds.GAME_OVER.setVolume(50),sounds.LEVEL_UP=new buzz.sound("sounds/levelUp",{formats:["wav"]}),sounds.HIT=new buzz.sound("sounds/hit",{formats:["wav"]}),sounds.LASER_SHOT=new buzz.sound("sounds/laserShot",{formats:["wav"]}),sounds.MONSTER_DEAD=new buzz.sound("sounds/monsterDead",{formats:["wav"]}),sounds.SHOOT=new buzz.sound("sounds/shoot",{formats:["wav"]}),buzz.all().load(),Tiles.prototype=Object.create(PIXI.DisplayObjectContainer.prototype),Tiles.prototype.addTile=function(a,b,c){var d=common.tiles[c.type],c=new PIXI.Sprite(d.texture);c.position.x=a*common.TILE_SIZE,c.position.y=b*common.TILE_SIZE,this.addChild(c)},Tiles.prototype.generateTiles=function(){for(var a=0;a<this.tilesHeight;a++)for(var b=0;b<this.tilesWidth;b++)this.addTile(b,a,this.tiles[a][b])};var world;World.prototype=Object.create(PIXI.DisplayObjectContainer.prototype),World.prototype.updateData=function(a){this.player.update(a),this.lifebar.update(a.hp,a.hpMax),this.expbar.update(a.level,a.exp,a.expToNextLevel)},World.prototype.updatePlayerData=function(a){this.players.hasOwnProperty(a.name)?this.players[a.name].update(a):(this.players[a.name]=new Other(a),this.addChild(this.players[a.name]))},World.prototype.removePlayer=function(a){this.players.hasOwnProperty(a)&&(this.removeChild(this.players[a]),delete this.players[a])},World.prototype.updateMonster=function(a){if(this.monsters.hasOwnProperty(a.id)){var b=this.monsters[a.id];b.update(a)}else this.monsters[a.id]=new Monster(a),this.addChild(this.monsters[a.id])},World.prototype.removeMonster=function(a){this.monsters.hasOwnProperty(a.id)&&(sounds.MONSTER_DEAD.play(),this.removeChild(this.monsters[a.id]),delete this.monsters[a.id])},World.prototype.isAvailable=function(a,b){if(!this.tiles.tiles[b][a].passable)return!1;for(var c in this.players){var d=this.players[c];if(d.data.x==a&&d.data.y==b)return!1}for(var c in this.monsters){var e=this.monsters[c];if(e.data.x==a&&e.data.y==b)return!1}return!0},World.prototype.addLaser=function(a){sounds.LASER_SHOT.play();var b=new Laser(a);this.lasers[a.id]=b,this.addChild(b)},World.prototype.removeLaser=function(a){this.removeChild(a),delete this.lasers[a.data.id]},World.prototype.frame=function(a){if(a%4==0&&this.player.frame(),a%5==0)for(var b in this.lasers)this.lasers[b].frame()};